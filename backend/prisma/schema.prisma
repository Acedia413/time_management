generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleName {
  STUDENT
  TEACHER
  ADMIN
}

enum PermissionAction {
  VIEW_TASKS
  CREATE_TASK
  SUBMIT_WORK
  REVIEW_SUBMISSION
  MANAGE_USERS
}

enum TaskStatus {
  DRAFT
  ACTIVE
  IN_REVIEW
  CLOSED
}

model User {
  id                 Int            @id @default(autoincrement())
  username           String         @unique
  password           String
  fullName           String
  roles              Role[]
  departmentId       Int?
  department         Department?    @relation(fields: [departmentId], references: [id])
  subjects           Subject[]
  groupId            Int?
  group              Group?         @relation(fields: [groupId], references: [id])
  createdTasks       Task[]         @relation("TasksCreated")
  tasksReviewing     Task[]         @relation("TasksReviewing")
  submissions        Submission[]
  taskPriorities     TaskPriority[]
  activities         ActivityLog[]
  gradedSubmissions  Submission[]   @relation("GradedSubmissions")
  taskComments       TaskComment[]
  subTasks           SubTask[]
}

model ActivityLog {
  id        Int      @id @default(autoincrement())
  action    String
  details   String?
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
}

model Role {
  id          Int          @id @default(autoincrement())
  name        RoleName     @unique
  users       User[]
  permissions Permission[] @relation("RolePermissions")
}

model Department {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  subjects Subject[]
  teachers User[]
}

model Subject {
  id           Int        @id @default(autoincrement())
  name         String
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  teachers     User[]
  tasks        Task[]

  @@unique([name, departmentId])
}

model Group {
  id       Int    @id @default(autoincrement())
  name     String @unique
  students User[]
  tasks    Task[]
}

model Permission {
  id     Int              @id @default(autoincrement())
  action PermissionAction @unique
  roles  Role[]           @relation("RolePermissions")
}

model Task {
  id                Int            @id @default(autoincrement())
  title             String
  description       String
  createdAt         DateTime       @default(now())
  status            TaskStatus     @default(ACTIVE)
  dueDate           DateTime?
  createdById       Int
  groupId           Int?
  subjectId         Int?
  inReviewStudentId Int?
  createdBy         User           @relation("TasksCreated", fields: [createdById], references: [id])
  group             Group?         @relation(fields: [groupId], references: [id])
  subject           Subject?       @relation(fields: [subjectId], references: [id])
  inReviewStudent   User?          @relation("TasksReviewing", fields: [inReviewStudentId], references: [id])
  submissions       Submission[]
  priorities        TaskPriority[]
  comments          TaskComment[]
  subTasks          SubTask[]

  @@unique([title, groupId])
}

model Submission {
  id          Int       @id @default(autoincrement())
  content     String?
  fileUrl     String?
  submittedAt DateTime  @default(now())
  grade       Int?
  gradedAt    DateTime?
  gradedById  Int?
  taskId      Int
  studentId   Int
  task        Task      @relation(fields: [taskId], references: [id])
  student     User      @relation(fields: [studentId], references: [id])
  gradedBy    User?     @relation("GradedSubmissions", fields: [gradedById], references: [id])

  @@unique([taskId, studentId])
}

model TaskPriority {
  id               Int  @id @default(autoincrement())
  userId           Int
  taskId           Int
  priority         Int  @default(0)
  estimatedMinutes Int?
  user             User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task             Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId])
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  taskId    Int
  authorId  Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author    User     @relation(fields: [authorId], references: [id])
}

model SubTask {
  id        Int      @id @default(autoincrement())
  title     String
  isDone    Boolean  @default(false)
  createdAt DateTime @default(now())
  orderNum  Int      @default(0)
  taskId    Int
  studentId Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  student   User     @relation(fields: [studentId], references: [id])

  @@unique([taskId, studentId, title])
}
